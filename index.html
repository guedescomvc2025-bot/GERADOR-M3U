<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>GERADOR DE M3U DARK</title>
<style>
  /* ==== VARIÁVEIS DE TEMA - TEMA ESCURO + RAIOS ==== */
  :root {
    --bg-color: #0a0a12;
    --bg-gradient: linear-gradient(135deg, #0a0a12 40%, #1a1a27 100%);
    --text-color: #e0e0ff;
    --accent-color: #63e6be;
    --accent-color-light: #a2fff0;
    --error-color: #ff5555;
    --success-color: #49d49d;
    --shadow-color: rgba(0, 200, 255, 0.6);
    --progress-bg: #222;
    --progress-fill: #00ffaa;
    --btn-bg: #12131f;
    --btn-hover-bg: #184846;
    --input-bg: #12131f;
    --input-border: #484848;
    --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  /* Reset e estilos base */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    margin: 0; 
    padding: 0;
    background: var(--bg-gradient);
    color: var(--text-color);
    font-family: var(--font-family);
    min-height: 100vh;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  
  /* ===== FUNDO RAIOS ANIMADOS ===== */
  .lightning {
    position: fixed;
    top: 0; 
    left: 0; 
    width: 100vw; 
    height: 100vh;
    pointer-events: none;
    z-index: 0;
    overflow: visible;
  }
  
  .lightning span {
    position: absolute;
    width: 2px; 
    height: 120px;
    background: linear-gradient(180deg, rgba(0,255,255,0.75), transparent);
    filter: drop-shadow(0 0 8px #00fff0);
    opacity: 0;
    animation: lightningAnim 3s linear infinite;
  }
  
  .lightning span:nth-child(1) { left: 10%; animation-delay: 0s; }
  .lightning span:nth-child(2) { left: 25%; animation-delay: 0.8s; }
  .lightning span:nth-child(3) { left: 40%; animation-delay: 1.5s; }
  .lightning span:nth-child(4) { left: 60%; animation-delay: 2.1s; }
  .lightning span:nth-child(5) { left: 75%; animation-delay: 2.7s; }
  
  @keyframes lightningAnim {
    0%, 80%, 100% { opacity: 0; transform: translateY(0); }
    85%, 95% { opacity: 1; transform: translateY(10px); }
  }
  
  /* ===== TÍTULO ANIMADO ===== */
  header {
    margin-top: 20px;
    margin-bottom: 15px;
    font-size: clamp(1.5rem, 5vw, 2.6rem);
    font-weight: 900;
    color: var(--accent-color);
    text-align: center;
    position: relative;
    user-select: none;
    min-height: 3rem;
    width: 100%;
    padding: 0 10px;
  }
  
  /* Typing effect */
  @keyframes typing {
    from { width: 0 }
    to { width: 100% }
  }
  
  @keyframes blinkCaret {
    50% { border-color: transparent; }
  }
  
  .typing {
    white-space: nowrap;
    overflow: hidden;
    border-right: 3px solid var(--accent-color);
    animation:
      typing 3s steps(15, end) forwards,
      blinkCaret 0.8s step-end infinite;
    width: 0;
    margin: 0 auto;
  }
  
  /* Flicker effect */
  @keyframes flicker {
    0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
      opacity: 1;
      text-shadow:
        0 0 7px var(--accent-color),
        0 0 20px var(--accent-color-light),
        0 0 30px var(--accent-color-light);
    }
    20%, 22%, 24%, 55% {
      opacity: 0.7;
      text-shadow: none;
    }
  }
  
  header.flicker {
    animation: flicker 3s linear infinite;
  }
  
  /* ===== CONTAINER CENTRAL ===== */
  main {
    width: 95%;
    max-width: 900px;
    background: rgba(10,10,18,0.85);
    box-shadow: 0 0 20px var(--shadow-color);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    z-index: 1;
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  
  /* ===== FORMULÁRIO ===== */
  form {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    align-items: center;
    margin-bottom: 15px;
  }
  
  /* ==== BOTÕES ==== */
  button {
    background-color: var(--btn-bg);
    border: none;
    border-radius: 6px;
    padding: 12px 18px;
    color: var(--accent-color);
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.25s ease, box-shadow 0.25s ease;
    box-shadow: 0 0 5px transparent;
    width: 100%;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  button:hover:not(:disabled) {
    background-color: var(--btn-hover-bg);
    box-shadow: 0 0 12px var(--accent-color);
  }
  
  button:disabled {
    color: #777;
    cursor: not-allowed;
    box-shadow: none;
  }
  
  /* ===== ESTATÍSTICAS ===== */
  .stats {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .stat-item {
    background: #112;
    padding: 8px 12px;
    border-radius: 8px;
    min-width: 100px;
    text-align: center;
    color: var(--accent-color-light);
    font-weight: 600;
    font-size: 0.85rem;
    user-select: none;
    box-shadow: 0 0 10px transparent;
    transition: box-shadow 0.3s ease;
  }
  
  .stat-item.hit {
    color: var(--success-color);
    box-shadow: 0 0 12px var(--success-color);
  }
  
  .stat-item.tested {
    color: var(--accent-color-light);
    box-shadow: 0 0 12px var(--accent-color);
  }
  
  /* ===== RESULTADOS ===== */
  .results-container {
    max-height: 300px;
    overflow-y: auto;
    background: #121522ee;
    border-radius: 12px;
    padding: 12px;
    font-family: monospace;
    font-size: 0.8rem;
    color: #a0f0ff;
    user-select: text;
    box-shadow: inset 0 0 8px #00ffeeb5;
    flex: 1;
    min-height: 150px;
  }
  
  /* Cada hit */
  .hit-item {
    background: #002633cc;
    border-radius: 10px;
    margin-bottom: 12px;
    padding: 10px;
    box-shadow: 0 0 10px #00ffff55;
    position: relative;
    transition: background-color 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .hit-item:hover {
    background: #005564cc;
  }
  
  .hit-content {
    flex-grow: 1;
    margin-right: 10px;
    word-break: break-all;
  }
  
  /* Botões do hit */
  .hit-actions {
    display: flex;
    gap: 5px;
  }
  
  .hit-actions button {
    background: transparent;
    border: none;
    color: var(--accent-color-light);
    font-size: 1rem;
    cursor: pointer;
    transition: color 0.3s ease;
    padding: 2px 6px;
    border-radius: 6px;
    width: auto;
    height: auto;
  }
  
  .hit-actions button:hover {
    color: var(--success-color);
  }
  
  /* BOTÕES GERAIS DE CONTROLE */
  .controls {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-top: 15px;
  }
  
  /* NOTIFICAÇÃO */
  #notification {
    position: fixed;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent-color);
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 0 20px var(--accent-color-light);
    color: #021212;
    font-weight: 700;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
    z-index: 1000;
    user-select: none;
    max-width: 90%;
    text-align: center;
    font-size: 0.9rem;
  }
  
  #notification.show {
    opacity: 1;
    pointer-events: auto;
  }
  
  /* Rodapé */
  footer {
    width: 100%;
    text-align: center;
    padding: 15px 0;
    color: var(--accent-color-light);
    font-size: 0.9rem;
    font-weight: 600;
    margin-top: auto;
    z-index: 1;
  }
  
  /* Espaço para anúncios */
  .ad-container {
    width: 100%;
    max-width: 728px;
    margin: 20px auto;
    text-align: center;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 10px;
    min-height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .ad-placeholder {
    color: #777;
    font-style: italic;
  }
  
  /* RESPONSIVO */
  @media (min-width: 601px) {
    .controls {
      grid-template-columns: repeat(4, 1fr);
    }
    
    button {
      width: auto;
    }
    
    .results-container {
      max-height: 450px;
      font-size: 0.88rem;
    }
    
    .stat-item {
      min-width: 120px;
      font-size: 1rem;
      padding: 10px 15px;
    }
    
    main {
      padding: 20px 25px;
    }
    
    header {
      margin-top: 40px;
      margin-bottom: 20px;
    }
  }
  
  @media (max-width: 360px) {
    .controls {
      grid-template-columns: 1fr;
    }
    
    .results-container {
      max-height: 200px;
      font-size: 0.75rem;
    }
    
    header {
      font-size: 1.3rem;
      margin-top: 15px;
      margin-bottom: 10px;
    }
  }
</style>
</head>
<body>
<div class="lightning" aria-hidden="true">
  <span></span><span></span><span></span><span></span><span></span>
</div>
<header aria-label="Título do scanner">
  <div class="typing flicker" id="animated-title">GERADOR DE M3U DARK</div>
</header>

<!-- Espaço para anúncios AdSense -->
<div class="ad-container">
  <div class="ad-placeholder">Espaço para anúncios AdSense</div>
</div>

<main>
  <form id="configForm" autocomplete="off" aria-label="Configurações do scanner">
    <input type="text" id="playlistUrl" placeholder="Cole a URL da playlist aqui" />
    <button id="generateBtn" type="button">GERAR M3U</button>
  </form>
  
  <div class="stats" aria-live="polite" aria-label="Estatísticas em tempo real">
    <div class="stat-item hit" id="totalHits">Hits: 0</div>
    <div class="stat-item tested" id="totalTested">Testados: 0</div>
  </div>
  
  <div class="controls" role="group" aria-label="Controles do scanner">
    <button id="stopBtn" type="button" disabled aria-pressed="false">Parar</button>
    <button id="clearBtn" type="button">Limpar</button>
    <button id="exportBtn" type="button" disabled>Exportar Hits</button>
    <button id="copyAllBtn" type="button" disabled>Copiar Todos</button>
  </div>
  
  <section class="results-container" id="results" tabindex="0" aria-label="Resultados dos hits encontrados" aria-live="polite" aria-relevant="additions">
    <!-- Resultados aparecerão aqui -->
  </section>
</main>
<footer>FEITO POR DARK MENSAGEIRO</footer>
<div id="notification" role="alert" aria-live="assertive"></div>
<script>
  // ===== CONSTANTES & ESTADOS =====
  const stopBtn = document.getElementById('stopBtn');
  const clearBtn = document.getElementById('clearBtn');
  const exportBtn = document.getElementById('exportBtn');
  const copyAllBtn = document.getElementById('copyAllBtn');
  const generateBtn = document.getElementById('generateBtn');
  const playlistUrlInput = document.getElementById('playlistUrl');
  const resultsContainer = document.getElementById('results');
  const notification = document.getElementById('notification');
  const stats = {
    totalHits: document.getElementById('totalHits'),
    totalTested: document.getElementById('totalTested'),
  };
  
  let resultsHits = [];
  let stopRequested = false;
  let totalHits = 0;
  let totalTested = 0;

  // Função para mostrar notificação visual e sonora
  function showNotification(msg, duration = 5000) {
    notification.textContent = msg;
    notification.classList.add('show');
    try {
      const audioCtx = new AudioContext();
      const oscillator = audioCtx.createOscillator();
      oscillator.type = 'triangle';
      oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
      oscillator.connect(audioCtx.destination);
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.15);
    } catch {}
    setTimeout(() => {
      notification.classList.remove('show');
    }, duration);
  }
  
  // Função delay util
  function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  
  // ===== FUNÇÃO PARA COPIAR TEXTO COM FALLBACK =====
  function copyToClipboard(text) {
    return new Promise((resolve, reject) => {
      // Tentar usar a API moderna do clipboard
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text)
          .then(() => resolve(true))
          .catch(err => {
            console.error('Erro ao copiar com API moderna:', err);
            // Fallback para método antigo
            fallbackCopyTextToClipboard(text, resolve, reject);
          });
      } else {
        // Usar método antigo diretamente se a API não estiver disponível
        fallbackCopyTextToClipboard(text, resolve, reject);
      }
    });
  }
  
  // ===== MÉTODO ANTIGO DE COPIA (FALLBACK) =====
  function fallbackCopyTextToClipboard(text, resolve, reject) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Evitar rolagem para o elemento
    textArea.style.position = "fixed";
    textArea.style.top = 0;
    textArea.style.left = 0;
    textArea.style.width = "2em";
    textArea.style.height = "2em";
    textArea.style.padding = 0;
    textArea.style.border = "none";
    textArea.style.outline = "none";
    textArea.style.boxShadow = "none";
    textArea.style.background = "transparent";
    textArea.style.opacity = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      document.body.removeChild(textArea);
      
      if (successful) {
        resolve(true);
      } else {
        reject(new Error('Não foi possível copiar o texto'));
      }
    } catch (err) {
      document.body.removeChild(textArea);
      reject(err);
    }
  }
  
  // ===== FUNÇÃO PARA RENDERIZAR UM HIT NA TELA =====
  function renderHit(hit, index) {
    const { url, name } = hit;
    
    // Cria div item
    const div = document.createElement('div');
    div.className = 'hit-item';
    div.setAttribute('tabindex', '0');
    div.setAttribute('aria-label', `Canal: ${name}`);
    
    // Conteúdo do hit
    const contentDiv = document.createElement('div');
    contentDiv.className = 'hit-content';
    contentDiv.textContent = `📺 ${name || 'Canal sem nome'}`;
    div.appendChild(contentDiv);
    
    // Botão de copiar
    const btnCopy = document.createElement('button');
    btnCopy.textContent = '📋';
    btnCopy.title = 'Copiar este link';
    btnCopy.setAttribute('aria-label', `Copiar link M3U do canal ${name}`);
    
    btnCopy.onclick = () => {
      copyToClipboard(url)
        .then(() => {
          showNotification(`Link copiado! Canal: ${name}`);
        })
        .catch(err => {
          console.error('Erro ao copiar:', err);
          showNotification('Falha ao copiar. Tente novamente.');
        });
    };
    
    const btnContainer = document.createElement('div');
    btnContainer.className = 'hit-actions';
    btnContainer.appendChild(btnCopy);
    div.appendChild(btnContainer);
    
    return div;
  }
  
  // ===== SHOW ESTATÍSTICAS =====
  function updateStats() {
    stats.totalHits.textContent = `Canais: ${totalHits}`;
    stats.totalTested.textContent = `Processados: ${totalTested}`;
  }
  
  // ===== PROCESSAR M3U =====
  async function processM3U(url) {
    if (stopRequested) return;
    
    try {
      // Usar nosso proxy local para acessar a playlist
      const proxyUrl = `/api/proxy?url=${encodeURIComponent(url)}`;
      
      // Fazer requisição para obter a playlist
      const response = await fetch(proxyUrl, {
        headers: { 
          'Accept': 'application/x-mpegurl, text/plain, */*',
          'X-Requested-With': 'XMLHttpRequest'
        },
        cache: 'no-store'
      });
      
      // Verificar se a resposta foi bem-sucedida
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      // Obter o texto da playlist
      const playlistText = await response.text();
      
      // Processar a playlist M3U
      const lines = playlistText.split('\n');
      const channels = [];
      let currentChannel = {};
      
      for (const line of lines) {
        if (line.startsWith('#EXTINF:')) {
          // Esta linha contém informações do canal
          const match = line.match(/#EXTINF:-1(?:\s+tvg-id="[^"]*")?(?:\s+tvg-name="[^"]*")?(?:\s+tvg-logo="[^"]*")?(?:\s+group-title="[^"]*")?,(.*)/);
          if (match) {
            currentChannel.name = match[1].trim();
          }
        } else if (line.startsWith('http')) {
          // Esta linha é a URL do canal
          currentChannel.url = line.trim();
          channels.push(currentChannel);
          currentChannel = {};
        }
        
        // Atualizar contador de processados
        totalTested++;
        updateStats();
        
        // Pequeno delay para não sobrecarregar a UI
        await delay(10);
        if (stopRequested) break;
      }
      
      return channels;
    } catch (error) {
      console.error('Erro ao processar M3U:', error);
      throw error;
    }
  }
  
  // ===== INICIA O PROCESSAMENTO DA PLAYLIST =====
  async function startProcessing() {
    const url = playlistUrlInput.value.trim();
    
    if (!url) {
      showNotification('Por favor, insira uma URL válida.');
      return;
    }
    
    // Reseta estado
    stopRequested = false;
    totalHits = 0;
    totalTested = 0;
    resultsHits = [];
    resultsContainer.innerHTML = '';
    updateStats();
    
    generateBtn.disabled = true;
    stopBtn.disabled = false;
    exportBtn.disabled = true;
    copyAllBtn.disabled = true;
    
    try {
      // Processar a playlist M3U
      const channels = await processM3U(url);
      
      if (stopRequested) {
        showNotification('Processamento interrompido.');
        return;
      }
      
      // Adicionar canais aos resultados
      resultsHits = channels;
      totalHits = channels.length;
      
      // Renderizar canais na UI (limitar a 20 para performance)
      const maxDisplay = Math.min(20, channels.length);
      for (let i = 0; i < maxDisplay; i++) {
        const channel = channels[i];
        const channelElement = renderHit(channel, i);
        resultsContainer.appendChild(channelElement);
      }
      
      if (channels.length > 20) {
        const moreElement = document.createElement('div');
        moreElement.className = 'hit-item';
        moreElement.textContent = `... e mais ${channels.length - 20} canais`;
        resultsContainer.appendChild(moreElement);
      }
      
      // Atualizar estatísticas
      updateStats();
      
      // Habilitar botões de exportação
      exportBtn.disabled = false;
      copyAllBtn.disabled = false;
      
      showNotification(`Playlist processada! ${totalHits} canais encontrados.`, 7000);
    } catch (error) {
      console.error('Erro:', error);
      showNotification(`Erro ao processar a playlist: ${error.message}`);
    } finally {
      generateBtn.disabled = false;
      stopBtn.disabled = true;
    }
  }
  
  // ===== LIMPA RESULTADOS E ESTADO DA UI =====
  function clearResults() {
    stopRequested = true;
    resultsHits = [];
    resultsContainer.innerHTML = '';
    totalHits = 0;
    totalTested = 0;
    updateStats();
    generateBtn.disabled = false;
    stopBtn.disabled = true;
    exportBtn.disabled = true;
    copyAllBtn.disabled = true;
  }
  
  // ===== EXPORTAR HITS PARA TXT =====
  function exportHits() {
    if (resultsHits.length === 0) {
      alert('Nenhum canal para exportar.');
      return;
    }
    
    const lines = resultsHits.map(h => `#EXTINF:-1,${h.name}\n${h.url}`);
    const content = '#EXTM3U\n' + lines.join('\n');
    
    const blob = new Blob([content], {type: "text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    // Criar link para download
    const a = document.createElement('a');
    a.href = url;
    a.download = `playlist-${new Date().toISOString().slice(0,10)}.m3u`;
    a.click();
    URL.revokeObjectURL(url);
  }
  
  // ===== COPIAR TODOS OS HITS =====
  function copyAllHits() {
    if (resultsHits.length === 0) {
      alert('Nenhum canal para copiar.');
      return;
    }
    
    const lines = resultsHits.map(h => `#EXTINF:-1,${h.name}\n${h.url}`);
    const content = '#EXTM3U\n' + lines.join('\n');
    
    copyToClipboard(content)
      .then(() => {
        showNotification('Playlist copiada para a área de transferência!');
      })
      .catch(err => {
        console.error('Erro ao copiar a playlist:', err);
        showNotification('Falha ao copiar. Tente novamente ou use a opção de exportar.');
      });
  }
  
  // ===== EVENT LISTENERS =====
  generateBtn.addEventListener('click', startProcessing);
  
  stopBtn.addEventListener('click', () => {
    stopRequested = true;
    stopBtn.disabled = true;
    generateBtn.disabled = false;
    showNotification('Processamento interrompido.');
  });
  
  clearBtn.addEventListener('click', () => {
    clearResults();
    showNotification('Resultados limpos.');
  });
  
  exportBtn.addEventListener('click', exportHits);
  copyAllBtn.addEventListener('click', copyAllHits);
  
  // ===== ACESSIBILIDADE =====
  // Define foco no container de resultados para leitores de tela
  resultsContainer.setAttribute('tabindex', '0');
  
  // Exemplo de URL pré-preenchida para testes
  window.addEventListener('load', () => {
    // playlistUrlInput.value = 'https://example.com/playlist.m3u';
  });
</script>
</body>
</html>
